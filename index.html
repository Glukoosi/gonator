<head>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
</head>
<body>
<div id="stream">
    <div class="progresbarholder">

            <div class="bargoal">eeE</div>
            <div class="bar" style="width:12%">56€</div>
        </div>
</div>
<div id="donation"></div>
<pre id="output"></pre>
</body>

<script>
    var output = document.getElementById("output");
    var donationsocket = new WebSocket("ws://localhost:8080/donations");
    var goalsocket = new WebSocket("ws://localhost:8080/goal");
    var total = 0;
    var donations = []
    var latest = []
    var goal = 0;

    $("#donation").hide();



    goalsocket.onmessage = function (event) {

	    goal = parseInt(event.data);
	    update()
    }

    donationsocket.onmessage = function (event) {
        console.log("onmessage");
        let first = false;
        if (donations.length === 0){
            console.log("first");
            first = true;
        } // check for first update after pageload

        let msg = JSON.parse(event.data);
        console.log(msg);
        msg.reverse().forEach(function (element) {
            let newdon = true;
            for (let i=0; i < donations.length; i ++){
                if (element.DonationId === donations[i].DonationId){
                    if (donations[i].Name === "Anonyymi" && donations[i].Message === ""){
                        donations[i].Name = element.Name;
                        donations[i].Message = element.Message;
                        latest.push(element)
                    }
                    newdon = false;
                }
            }
            if (newdon){
                donations.push(element);
                total += element.Amount;
                update()
                if (element.Name !== "Anonyymi" && element.Message !== ""){
                    latest.push(element)
                }
            }
        });
        if (first){
            latest = []
        } // do not display everything after pageload
        if (latest.length > 0){
            displaydonation()
        }

        var html = ""
        html += "<table>"
        donations.slice().reverse().forEach(function (donation) {
            html += "<tr><td class='name'>" + donation.Name + "</td>";
            html += "<td class='message'>" + donation.Message + "</td>";
            html += "<td class='amount'>" + donation.Amount + "€" + "</td></tr>";
        });
        html += "</table>"
        output.innerHTML = html;
    };
    function displaydonation() {
        console.log("displaydon")
        $("#donation").show("slow")
        $("#donation").text(latest[0].Name + " " + latest[0].Amount + "€");
        setTimeout(removedonation, 15000)
    }
    function removedonation() {
        latest.shift();
        $("#donation").hide("slow");
        if (latest.length > 0){
            displaydonation()
        }
    }
    // setInterval(update, 500);


    function update() {
        $(".bar").css("width", String(total/goal * 100) + "%" ).text(total + "€")
        $(".bargoal").text(goal + "€")
    }

</script>

<style>
    @font-face {
        font-family: 'electricboots';
        src:  url('ELECTRICBOOTS.ttf') format('truetype');
    }

    html {
        padding: 0;
        margin: 0;
        max-width: 100%;
    }
    body {
        background-color: #061068;
        max-width: 100%;
        color: white;
        padding: 0;
        font-size: 18px;
        margin: 0;
    }
    table{
        font-size: 18px;
        width: 100%;
        table-layout: fixed;
    }
    td{
        word-wrap: break-word;
        padding-bottom: 10px;
    }
    tr:nth-child(odd){
        background-color: #131d74;
    }

    .amount{
        width: 10%;
    }
    .message{
        width: 65%%;
    }
    .name{
        width: 25%;
    }

    #stream {
        height: 100px;
        padding: 20px;
        font-size: 50px;
        text-align: center;
		background-color: black;
        font-family: "electricboots";
    }
    #donation{
        position: relative;
        margin-top: -100px;
        height: 100px;
        font-size: 50px;
        text-align: center;
		background-color: black;
        font-family: "electricboots";
        z-index: 100;
    }


    .progresbarholder{
        margin: 20px 0;
        border: solid 3px white;
        border-radius: 8px;
        padding: 5px;
        overflow: hidden;
    }
    .bar{
        background-color: #00b702;
        border-radius: 4px;
        height: 50px;
        padding-left: 13px;
        box-sizing: border-box;
        text-align: left;
        line-height: 50px;
    }
    .bargoal{
        float: right;
        height: 50px;
        line-height: 50px;
        width: 100%;
        text-align: right;
        padding-right: 13px;
        box-sizing: border-box;
        margin-bottom: -50px;
    }

</style>
