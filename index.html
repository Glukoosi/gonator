<head>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
</head>
<body>
<div id="stream">
    <div class="progresbarholder">

            <div class="bargoal">eeE</div>
            <div class="bar" style="width:12%">56€</div>
        </div>
</div>
<div id="donation"></div>
<div id="outputs">
<div id="donates">
    <pre id="output"></pre>
</div>
    <div id="tags">
        <pre id="tagoutput"></pre>
    </div>
    </div>
</body>

<script>
    var output = document.getElementById("output");
    var tagoutput = document.getElementById("tagoutput");
    var donationsocket = new WebSocket("wss://gonator2.glukoo.si/donations");
    var goalsocket = new WebSocket("wss://gonator2.glukoo.si/goal");
    var total = 0;
    var donations = []
    var latest = []
    var goal = 0;
    var hashtags = {}
    var display = false
    $("#donation").hide();



    goalsocket.onmessage = function (event) {

	    goal = parseInt(event.data);
	    update()
    }

    donationsocket.onmessage = function (event) {

        let msg = JSON.parse(event.data);
        console.log(msg);

        msg["Donations"].forEach(function (d) {
            if (d["OperationType"] === "insert"){
                donations.push(d["Donation"]);
                total += d["Donation"].Amount
                if (d["Donation"].Name !== "Anonyymi" || d["Donation"].Message !== ""){
                    latest.push(d["Donation"])
                    dotags(d["Donation"])
                }
            } else if (d["OperationType"] === "firstInsert"){
                donations.push(d["Donation"]);
                dotags(d["Donation"]);
                total += d["Donation"].Amount

            } else if (d["OperationType"] === "update"){
                for (let i=0; i < donations.length; i ++) {
                    if (d['Donation'].DonationId === donations[i].DonationId) {
                        donations[i].Message = d["Donation"].Message;
                        donations[i].Name = d["Donation"].Name
                    }
                }
                latest.push(d["Donation"])
                dotags(d["Donation"])
            } else {
                console.log("Something terribly wrong")
            }
            update()

        });

        if (latest.length > 0){
            if (!display){
                display = true
                displaydonation()
            }
        }

        var html = "";
        html += "<table>";
        donations.slice().reverse().forEach(function (donation) {
            html += "<tr><td class='name'>" + donation.Name + "</td>";
            html += "<td class='message'>" + donation.Message + "</td>";
            html += "<td class='amount'>" + donation.Amount + "€" + "</td></tr>";
        });
        html += "</table>"
        output.innerHTML = html;
    };
    function displaydonation() {
        console.log("displaydon")
        $("#donation").show("slow")
        $("#donation").text(latest[0].Name + " " + latest[0].Amount + "€");
        setTimeout(removedonation, 15000)
    }

    function removedonation() {
        latest.shift();
        $("#donation").hide("slow");
        if (latest.length > 0){
            displaydonation()
        } else {
            display = false
        }
    }

    function dotags(d) {
        var htags = []
        var words = d["Message"].split(" ")
        for (var i = 0; i < words.length; i++){
            if (words[i][0] === "#" && words[i].length > 1){
                htags.push(words[i])
            }
        }
        for (var i = 0; i < htags.length; i++){
            if (!(htags[i] in hashtags)){
                hashtags[htags[i]] = {"total": 0, "donates": []}
            }
            hashtags[htags[i]]["donates"].push({
                    "name": d["Name"],
                    "amount": d["Amount"]/(htags.length),
                    "msg": d["Message"],
                })
            hashtags[htags[i]]["total"] += d["Amount"]/(htags.length)
            hashtags[htags[i]]["donates"].sort(function (f, s) {
                return f["amount"] - s["amount"]
            })
        }

        var html = "";
        html += "<table>";

        for (var i = 0; i < Object.keys(hashtags).length; i++) {
            var tags = Object.keys(hashtags)
            html += "<tr><td class='name'>" + tags[i] + "</td>";
            html += "<td class='message'>Total: " + hashtags[tags[i]]["total"] + "</td><td class='amount'></td></tr>";
            for (var j = 0; j < hashtags[tags[i]]["donates"].length; j++){
                var dons = hashtags[tags[i]]["donates"]
                html += "<tr><td class='name'>- " + dons[j]["name"] + "</td>";
                html += "<td class='message'>" + dons[j]["msg"] + "</td>";
                html += "<td class='amount'>" + dons[j]["amount"] + "</td></tr>";
            }
            html += "<tr><td class='name'>-</td>";
            html += "<td class='message'>-</td>";
            html += "<td class='amount'>-</td></tr>";
        }
        html += "</table>"
        tagoutput.innerHTML = html;
    }

    function update() {
        $(".bar").css("width", String(total/goal * 100) + "%" ).text(total + "€")
        $(".bargoal").text(goal + "€")
    }

</script>

<style>
    @font-face {
        font-family: 'electricboots';
        src:  url('ELECTRICBOOTS.ttf') format('truetype');
    }

    html {
        padding: 0;
        margin: 0;
        max-width: 100%;
    }
    body {
        background-color: #061068;
        max-width: 100%;
        color: white;
        padding: 0;
        font-size: 18px;
        margin: 0;
    }
    table{
        font-size: 18px;
        width: 100%;
        table-layout: fixed;
    }
    td{
        word-wrap: break-word;
        padding-bottom: 10px;
    }
    tr:nth-child(odd){
        background-color: #131d74;
    }

    .amount{
        width: 10%;
    }
    .message{
        width: 65%;
    }
    .name{
        width: 25%;
    }

    #stream {
        height: 100px;
        padding: 20px;
        font-size: 50px;
        text-align: center;
		background-color: black;
    }
    #donation{
        position: relative;
        margin-top: -100px;
        height: 100px;
        font-size: 50px;
        text-align: center;
		background-color: black;
        z-index: 100;
    }


    .progresbarholder{
        margin: 20px 0;
        border: solid 3px white;
        border-radius: 8px;
        padding: 5px;
        overflow: hidden;
    }
    .bar{
        background-color: #00b702;
        border-radius: 4px;
        height: 50px;
        padding-left: 13px;
        box-sizing: border-box;
        text-align: left;
        line-height: 50px;
    }
    .bargoal{
        float: right;
        height: 50px;
        line-height: 50px;
        width: 100%;
        text-align: right;
        padding-right: 13px;
        box-sizing: border-box;
        margin-bottom: -50px;
    }
    #outputs{
        display: flex;
    }

    #donates{
        width: 50%;
    }
    #tags{
        width: 50%;
    }
</style>
